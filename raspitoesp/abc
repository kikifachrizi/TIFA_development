import serial
import time

# Ganti sesuai port ESP32 kamu (misal: /dev/ttyUSB0 atau /dev/ttyS0)
esp32 = serial.Serial('/dev/ttyUSB0', 115200, timeout=1)
time.sleep(2)  # Tunggu koneksi serial stabil

try:
    # Kirim perintah '1' ke ESP32
    esp32.write(b'1\n')
    print(">> Kirim ke ESP32: 1")

    buffer_baterai = []  # Menyimpan baris-baris info baterai

    while True:
        if esp32.in_waiting > 0:
            response = esp32.readline().decode(errors="ignore").strip()

            if not response:
                continue

            print("<<", response)

            # Tangkap data baterai jika ada
            if "===== MONITORING TEGANGAN" in response:
                buffer_baterai = [response]
            elif buffer_baterai:
                buffer_baterai.append(response)
                if "====" in response and len(buffer_baterai) >= 6:
                    print("\n--- STATUS BATERAI DARI ESP32 ---")
                    for line in buffer_baterai:
                        print(line)
                    print("----------------------------------\n")
                    buffer_baterai = []

            # Tindak lanjuti status pintu
            if response == "[ESP32] Dapat '1' dari Raspberry Pi - mulai buka pintu":
                print("Status: Perintah diterima, membuka pintu.")
            elif response == "TERBUKA":
                print("Status: Pintu berhasil terbuka.")
            elif response == "TERTUTUP":
                print("Status: Pintu tertutup kembali.")
                break  # keluar setelah pintu tertutup (optional)

except KeyboardInterrupt:
    print("\nProgram dihentikan oleh pengguna.")

finally:
    esp32.close()
    print("Koneksi serial ditutup.")
